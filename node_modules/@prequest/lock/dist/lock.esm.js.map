{"version":3,"file":"lock.esm.js","sources":["../src/index.ts"],"sourcesContent":["import { AsyncPromise } from '@xdoer/x'\nimport { Options } from './types'\n\nexport type LockOptions = Options\n\nexport default class Lock {\n  on = false\n\n  constructor(private opt: Options) {\n    const { promise, resolve } = new AsyncPromise()\n    this.promise = promise\n    this.resolvePromise = resolve\n  }\n\n  async getValue() {\n    return this.opt.getValue()\n  }\n\n  async setValue(value: any) {\n    return this.opt.setValue(value)\n  }\n\n  async clear() {\n    if (this.on) return\n    const { promise, resolve } = new AsyncPromise()\n    this.promise = promise\n    this.resolvePromise = resolve\n    return this.opt.clearValue()\n  }\n\n  resolvePromise: any\n  promise: Promise<any>\n\n  static createLockWrapper(lock: Lock) {\n    return async function(fn: () => Promise<any>) {\n      if (lock.on) return lock.promise\n\n      lock.on = true\n\n      const value = (await lock.getValue()) || (await fn())\n      await lock.setValue(value)\n\n      lock.on = false\n\n      lock.resolvePromise(value)\n\n      return value\n    }\n  }\n}\n"],"names":["Lock","constructor","opt","promise","resolve","AsyncPromise","resolvePromise","getValue","setValue","value","clear","on","clearValue","createLockWrapper","lock","fn"],"mappings":";;MAKqBA;AAGnBC,EAAAA,YAAoBC;AAAA,YAAA,GAAAA,GAAA;AAFpB,WAAA,GAAK,KAAL;AAGE,UAAM;AAAEC,MAAAA,OAAF;AAAWC,MAAAA;AAAX,QAAuB,IAAIC,YAAJ,EAA7B;AACA,SAAKF,OAAL,GAAeA,OAAf;AACA,SAAKG,cAAL,GAAsBF,OAAtB;AACD;;AAEa,QAARG,QAAQ;AACZ,WAAO,KAAKL,GAAL,CAASK,QAAT,EAAP;AACD;;AAEa,QAARC,QAAQ,CAACC,KAAD;AACZ,WAAO,KAAKP,GAAL,CAASM,QAAT,CAAkBC,KAAlB,CAAP;AACD;;AAEU,QAALC,KAAK;AACT,QAAI,KAAKC,EAAT,EAAa;AACb,UAAM;AAAER,MAAAA,OAAF;AAAWC,MAAAA;AAAX,QAAuB,IAAIC,YAAJ,EAA7B;AACA,SAAKF,OAAL,GAAeA,OAAf;AACA,SAAKG,cAAL,GAAsBF,OAAtB;AACA,WAAO,KAAKF,GAAL,CAASU,UAAT,EAAP;AACD;;AAKuB,SAAjBC,iBAAiB,CAACC,IAAD;AACtB,WAAO,gBAAeC,EAAf;AACL,UAAID,IAAI,CAACH,EAAT,EAAa,OAAOG,IAAI,CAACX,OAAZ;AAEbW,MAAAA,IAAI,CAACH,EAAL,GAAU,IAAV;AAEA,YAAMF,KAAK,GAAG,CAAC,MAAMK,IAAI,CAACP,QAAL,EAAP,MAA4B,MAAMQ,EAAE,EAApC,CAAd;AACA,YAAMD,IAAI,CAACN,QAAL,CAAcC,KAAd,CAAN;AAEAK,MAAAA,IAAI,CAACH,EAAL,GAAU,KAAV;AAEAG,MAAAA,IAAI,CAACR,cAAL,CAAoBG,KAApB;AAEA,aAAOA,KAAP;AACD,KAbD;AAcD;;;;;;"}